 C2P 演进路线图：从终端控制到全面电脑操控                                      

 Context

 C2P 当前是一个远程终端控制系统（Node.js + xterm.js + WebSocket），支持手机浏览器操控电脑
 shell。用户希望在三个方向上演进：
 1. 突破终端限制，实现手机对电脑的全面操控（桌面流、文件管理、系统监控）
 2. 性能优化与技术栈升级
 3. 移动端体验提升

 当前基线（已更新，2026-02-15）：
 - Phase 0 已完成：单体后端/前端已拆分为可插拔模块
 - src/server.ts 已精简为启动入口（138 行）
 - public/app.js 已精简为模块组装入口（27 行）
 - 后续可直接并行推进 Phase 1（后端传输优化）与 Phase 2（前端 UX 增强）

当前执行进度
- [x] Phase 0: 架构解耦
- [x] Phase 1: 性能优化（1.1/1.2 已完成并验收通过）
- [x] Phase 2: 移动端体验增强（2.1-2.5 已完成并验收通过）
- [ ] Phase 3: 桌面流
- [ ] Phase 4: 文件管理 + 系统监控
- [ ] Phase 5: 长期方向

 ---
 Phase 0: 架构解耦（已完成并通过验收）

 将单体拆分为可插拔模块，使后续功能增量接入。

 后端拆分（已完成）

 - src/server.ts → 精简为启动入口（~100行），只负责 Express 初始化 + WebSocket upgrade 路由分发
 - 提取 src/routes/api.ts（REST
 API）、src/ws/control.ts（控制通道）、src/ws/terminal.ts（终端通道）、src/tunnel.ts（隧道管理）
 - 引入 WsChannel 接口，后续加 /ws/desktop、/ws/file 只需注册新 channel

 前端模块化（已完成）

 - public/app.js IIFE → ES modules（<script type="module">），无需 bundler
 - 拆分为 public/lib/state.js、public/lib/term.js、public/lib/control.js、public/lib/ui.js

 协议版本化（已完成）

 - 控制通道握手加入 { type: 'hello', version: 1, capabilities: ['shell'] }，为后续功能协商预留

 落地文件（实际）

- src/server.ts — 启动入口 + WebSocket upgrade 分发
- src/routes/api.ts — REST API 路由
- src/ws/channel.ts — WsChannel 接口
- src/ws/control.ts — 控制通道（含 hello 握手）
- src/ws/terminal.ts — 终端通道
- src/tunnel.ts — 隧道管理
- public/app.js — ES module 启动器
- public/lib/state.js — 前端共享状态与通用工具
- public/lib/term.js — 终端模块
- public/lib/control.js — 控制通道模块
- public/lib/ui.js — UI/交互模块
- public/index.html — `type="module"` 引用
- public/sw.js — APP_SHELL_ASSETS 更新（含 `public/lib/*.js`）

 Phase 0 验收记录（2026-02-15）
 - `npm run build` 通过
 - API smoke 通过：`/api/runtime`、`/api/sessions`、`/api/tasks`
 - WebSocket control smoke 通过：连接后收到 `hello` + `sessions`
 - 端到端 smoke 通过：`spawn -> terminal 输出 -> kill -> exited`

 ---
 Phase 1: 性能优化（1.1/1.2 已完成并通过验收）

 1.1 二进制 WebSocket 协议

 终端通道（/ws/terminal）从 UTF-8 文本切换为二进制帧：
 [1B type][4B sessionId hash][NB payload]
 控制通道保持 JSON（低频管理消息，可读性优先）。通过 hello 握手协商版本，向后兼容。

1.2 WebSocket 压缩

启用 ws 库的 per-message deflate（zlibDeflateOptions.level: 1，threshold 128B）。终端 ANSI 输出压缩率通常
60-80%。

 落地状态（2026-02-15）

 - [x] 1.1 二进制 WebSocket 协议：终端通道按 `[1B type][4B sessionId hash][NB payload]` 收发，控制通道保留 JSON
 - [x] 协议协商：`hello` 握手能力升级为 `['shell', 'terminal.binary.v1']`，前后端按能力协商决定终端编码
 - [x] 1.2 WebSocket 压缩：`/ws/control` 与 `/ws/terminal` 启用 `perMessageDeflate`（`level:1`、`threshold:128`）
 - [ ] 1.3 Bun 运行时迁移（可选，暂未执行）
 - [ ] 1.4 存储升级（暂未执行）

 1.3 Bun 运行时迁移（可选）

 - Bun 原生 PTY 支持可替代 node-pty，消除 native addon 编译问题，PTY 启动延迟降低 2-4x
 - 创建 src/pty-backend.ts 抽象层，运行时检测选择 NodePty / BunPty 后端
 - Express + ws 在 Bun 上直接运行

 1.4 存储升级

 - store.ts JSON 文件 → SQLite（Bun 内置 bun:sqlite / Node 用 better-sqlite3）
 - 启动时自动检测旧 JSON 文件并迁移

关键文件

 - src/ws/terminal.ts（Phase 0 拆分后）— 二进制协议
 - src/ws/control.ts — hello 能力协商
 - src/ws/ws-config.ts（新建）— WebSocket 压缩参数
 - public/lib/state.js — 前端帧编解码与能力状态
 - public/lib/control.js — 前端 hello 协商
 - public/lib/term.js — 二进制输入输出与兼容回退
 - src/pty-manager.ts — PTY 后端抽象
 - src/store.ts — SQLite 迁移

 Phase 1 验收记录（2026-02-15）
 - `npm run build` 通过
 - `control` 通道压缩验收通过：`permessage-deflate` 已协商
 - `terminal` 通道压缩验收通过：`permessage-deflate` 已协商
 - 二进制帧头验收通过：`type=1/2` + `session hash` 校验通过
 - 端到端验收通过：`spawn -> binary output -> binary input -> kill -> exited`

 ---
 Phase 2: 移动端体验增强

 2.1 触控手势

 - 双指缩放 → 调整 xterm fontSize + refit
 - 左右滑动 → 切换会话 tab
 - 长按 → 文本选择 + 上下文菜单（复制/粘贴）
 - 新建 public/lib/gestures.js

 2.2 快捷键增强

 当前固定 8 按钮 → 可配置多行：控制键行 + 方向键/符号行 + 用户自定义命令行。配置存 localStorage，长按编辑。

 2.3 剪贴板双向同步

 - 电脑→手机：在 pty-manager.ts 检测 PTY 输出中的 OSC 52 序列（\e]52;c;BASE64\a），通过控制通道推送到前端调用
 navigator.clipboard.writeText()
 - 零额外依赖，利用终端协议本身能力

 2.4 重连体验

 - 可视化重连进度条（终端区域顶部）
 - 监听 navigator.onLine + online 事件立即重连
 - 重连时保留终端内容，不清屏

 2.5 分屏终端

 - #terminal-wrap 内 CSS Grid 布局，支持水平/垂直分屏
 - 每个 pane 独立 /ws/terminal 连接
 - 最多 4 pane（手机屏幕限制）
 - 长按 session tab → "在新面板中打开"

关键文件

 - public/lib/gestures.js（新建）
 - public/lib/term.js（Phase 0 拆分后）— 分屏逻辑
 - public/lib/ui.js — 快捷键面板
 - public/lib/control.js — 剪贴板同步消息落地
 - public/lib/state.js — 分屏/快捷键状态与常量
 - public/index.html — 分屏容器与重连进度条结构
 - src/pty-manager.ts — OSC 52 检测
 - src/ws/control.ts — OSC 52 控制通道广播
 - public/style.css — 分屏/手势 UI
 - public/sw.js — APP_SHELL_ASSETS 增加 `public/lib/gestures.js`

 Phase 2 落地状态（2026-02-15）

 - [x] 2.1 触控手势：双指缩放字体、左右滑动切会话、长按复制/粘贴菜单
 - [x] 2.2 快捷键增强：控制键行 + 方向/符号行 + 自定义命令行（localStorage 持久化，长按编辑）
 - [x] 2.3 剪贴板同步：后端识别 OSC 52，控制通道推送，前端写入系统剪贴板
 - [x] 2.4 重连体验：终端重连进度条 + `online/offline` 事件快速重连 + 重连不清屏
 - [x] 2.5 分屏终端：`#terminal-wrap` CSS Grid 分屏、每 pane 独立 `/ws/terminal`、最多 4 pane、长按会话标签新开面板

 Phase 2 验收记录（2026-02-15）
 - `npm run build` 通过
 - 终端链路 smoke 通过：`spawn -> output -> kill -> exited`
 - OSC 52 剪贴板链路 smoke 通过：`printf '%b' '\\x1b]52;c;dGVzdA==\\x07'`
 - 前端语法验收通过：`node --check public/app.js public/lib/{state,control,term,ui,gestures}.js`

 ---
 Phase 3: 桌面流 — 全面操控电脑

 技术选型：noVNC（推荐）
 ┌────────────────┬───────────────────────┬───────────────────────┐
 │      对比      │         noVNC         │        WebRTC         │
 ├────────────────┼───────────────────────┼───────────────────────┤
 │ 延迟           │ ~100-200ms            │ ~50ms                 │
 ├────────────────┼───────────────────────┼───────────────────────┤
 │ 与现有架构集成 │ 复用 WebSocket + 隧道 │ 需要 STUN/TURN        │
 ├────────────────┼───────────────────────┼───────────────────────┤
 │ 服务端         │ x11vnc/wayvnc         │ 屏幕捕获 + 编码进程   │
 ├────────────────┼───────────────────────┼───────────────────────┤
 │ 复杂度         │ 低（WebSocket 代理）  │ 高（信令 + NAT 穿透） │
 └────────────────┴───────────────────────┴───────────────────────┘
 选 noVNC 因为：复用现有 WebSocket 基础设施和隧道，不需要额外的 STUN/TURN 服务器，成熟稳定。

 架构

 手机浏览器 ──WebSocket──► C2P Server (VNC Proxy) ──TCP──► x11vnc/wayvnc (:5900)
   noVNC        /ws/desktop     src/ws/desktop.ts           本地 VNC server

 新增文件

 - src/ws/desktop.ts（~150行）— WebSocket↔TCP VNC 代理（即内嵌 websockify）
 - src/vnc-manager.ts（~200行）— 自动检测并管理 VNC server 进程（x11vnc/wayvnc/macOS 内置）
 - public/lib/desktop.js（~200行）— noVNC 集成 + 触控映射

 前端 UI

 - 模式切换 tab：[终端] [桌面]
 - 桌面模式：触控板模式（相对位移）/ 直接点击模式（绝对位置）
 - 虚拟修饰键：Ctrl/Alt/Win
 - 帧率默认 15fps（可调），优先 Tight 编码

 ---
 Phase 4: 文件管理 + 系统监控

 4.1 文件管理器

 REST API：/api/fs/{list,read,write,mkdir,rename,remove,download,upload}
 - 安全：路径遍历防护（path.resolve() + startsWith() 校验）
 - 上传限制 100MB，下载流式无限制
 - 前端：终端风格列表视图，拖拽上传，长按操作菜单

 4.2 系统监控

 API：GET /api/system/stats → CPU/内存/磁盘/网络/uptime
 - 实现：os 模块 + /proc 文件系统
 - 前端：dock 展开面板中显示，CSS 条形图（不引入图表库），5秒轮询

 关键文件

 - src/routes/api.ts（Phase 0 拆分后）— 新增 fs/system 路由
 - public/lib/files.js（新建）
 - public/lib/monitor.js（新建）

 ---
 Phase 5: 长期方向（可选）

 - WebRTC 桌面流：LAN 环境下替代 noVNC 获得更低延迟，作为 Phase 3 的升级路径
 - Ghostty WASM 终端：替代 xterm.js 的长期方向，目前尚不成熟，持续关注
 - 多用户权限：多 token + admin/viewer 角色，viewer 只读

 ---
 阶段依赖

 Phase 0 (架构解耦)
   ├─► Phase 1 (性能优化)  ─► Phase 3 (桌面流)
   └─► Phase 2 (UX 增强)   ─► Phase 4 (文件管理+监控)
                                Phase 5 (长期方向)
 Phase 1 和 Phase 2 可并行（后端/前端独立）。Phase 3 依赖 Phase 1 的传输优化。

 ---
 验证方式

 - Phase 0: 已完成并通过。`npm run build`、API/WebSocket/e2e smoke 均通过
 - Phase 1: 用 wscat 或浏览器 DevTools 验证二进制帧格式；对比压缩前后 WebSocket 流量大小
 - Phase 2: 手机浏览器实测手势、快捷键、分屏；OSC 52 剪贴板用 printf '\e]52;c;dGVzdA==\a' 测试
 - Phase 3: 手机浏览器切换到桌面模式，验证画面流畅度和触控输入响应
 - Phase 4: 手机浏览器上传/下载文件，查看系统监控数据实时更新
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
