
  # C2P 前端交互重构方案：移除自定义快捷键 + 控制面板整页滚动 + 终端按内容扩展

  ## Summary

  目标是完成三项改造并保持现有终端与控制通道能力不回退：

  1. 删除“自定义快捷键”能力，仅保留固定快捷键。
  2. 点击“控制面板”展开后，终端区与控制面板进入同一页面滚动，不再是控制面板内部单独滚
     动。
  3. 终端显示区取消“大面积预留”，改为较小起始高度并随内容自然扩展。

  ## Implementation Scope

  涉及文件：

  - public/lib/ui.js
  - public/lib/state.js
  - public/style.css
  - public/index.html（仅在必要时做结构最小调整）

  不涉及服务端协议与后端逻辑：

  - src/** 无需改动。

  ## Decision-Complete Design

  ### 1. 删除“自定义快捷键”功能（保留固定快捷键）

  在 public/lib/ui.js 执行以下改造：

  1. 删除 loadQuickKeyConfig、saveQuickKeyConfig、decodeEscapedSequence、
     encodeEscapedSequence 及 quickKeyConfig 状态。
  2. QuickKeys.render() 只渲染 QUICK_KEY_ROWS 的固定按钮行，不再创建 customRow、+ 命
     令 按钮。
  3. 删除 askForCustomCommand、addCustom、editCustom，以及与长按编辑相关的定时器/事件
     分支。
  4. 保留 runSequence 与固定快捷键 click 发送逻辑。
  5. 在 bootstrap() 增加一次兼容清理：
     localStorage.removeItem(QUICK_KEY_STORAGE_KEY)，避免旧数据残留。
  6. 在 public/lib/state.js 删除不再使用的 QUICK_KEY_STORAGE_KEY 导出。

  ### 2. 控制面板展开后改为“整页同滚”

  核心原则：改为单一主滚动容器，去掉控制面板内部滚动闭环。

  在 public/style.css 改造布局：

  1. 取消 body { overflow: hidden; }，改为允许页面滚动。
  2. 将 .app 从固定视口高度布局改为 min-height: 100dvh，并让内容可自然撑高。
  3. #terminal-wrap 从“独立滚动容器”改为普通流式容器：
      - 去掉 overflow-y: auto、overscroll-behavior: contain。
      - 保留必要横向滚动能力（仅终端内部）。
  4. .dock 从 position: fixed 改为文档流定位（如 position: sticky; bottom: 0 或直接静
     态流）。
      - 采用 sticky 方案：收起时仍贴底可见，展开后内容参与整页滚动。
  5. .dock-panel 展开态移除内部 overflow-y: auto，避免“面板内滚动孤岛”。
  6. 根据新滚动模型，移除/弱化 #terminal-wrap 对 --dock-height 的大底部补白依赖，避免
     空白区域。

  在 public/lib/ui.js 同步行为：

  1. Dock.updateHeight() 不再以“限制固定底栏高度”为目标。
      - 改成仅在必要时同步 CSS 变量，或简化为 no-op。
  2. 保留 Dock.expand/collapse/toggle 的 class 切换逻辑。
  3. 保留 dock-handle 点击和上/下滑展开收起手势。
  4. Viewport.applyInset() 保留软键盘偏移相关逻辑，但不再强依赖固定底栏高度计算；避免
     反复触发布局抖动。

  ### 3. 终端改为“小起始 + 按内容扩展”

  在 public/style.css 调整高度策略：

  1. .terminal-grid：
      - 由 min-height: clamp(280px, 62vh, 760px) 改为较小起始值（例如 min-height:
        120px）。
      - flex: 1 0 auto 改为更自然的内容驱动（必要时 display: grid 保留，但不强制占满
        大高度）。
  2. .terminal-pane：
      - min-height 从 176px 下调到较小值（如 96px 或 112px）。
  3. .terminal-pane-terminal：
      - 保持 xterm 可渲染高度，但不再绑定“必须撑满大容器”的策略。
  4. 保留多面板布局规则（data-pane-count=2/3/4），仅降低基线高度，避免回归成不可读的
     极小面板。

  在 public/lib/term.js 保持现有 fitAddon.fit() 逻辑，不改协议：

  1. 继续使用 scheduleResize() 与 ResizeObserver。
  2. 若出现初次渲染行数过低，补充一次 requestAnimationFrame + scheduleResize(true) 兜
     底（仅在需要时加）。

  ## Public API / Interface Changes

  1. 前端本地存储接口变化：
      - 移除 QUICK_KEY_STORAGE_KEY 的功能性使用（历史数据仅做一次清理）。
  2. 无网络协议变更：
      - /ws/control、/ws/terminal、resize 消息结构不变。
  3. DOM 接口对外无新增 id/class 要求，仅内部样式与行为调整。

  ## Test Cases & Acceptance Criteria

  ### A. 自定义快捷键删除

  1. 页面不再出现“+ 命令”按钮。
  2. 长按快捷键不再弹出新增/编辑对话框。
  3. 固定快捷键（^C、方向键、Tab、Esc、Enter）可正常发送。
  4. 本地旧 c2p_quick_keys_v1 数据不会影响页面渲染。

  ### B. 控制面板整页同滚

  1. 点击“控制面板”展开后，手指上滑时终端区与面板内容属于同一连续滚动体验。
  2. 不再出现“只能在控制面板内部滚动”的锁死感。
  3. 收起/展开按钮行为与当前一致（点击切换、手势上滑展开下滑收起）。
  4. 移动端键盘弹出时，无明显布局抖动或遮挡不可操作区域。

  ### C. 终端高度策略

  1. 初始空终端不再占据过大空白区域。
  2. 有输出后页面高度可自然增长并通过整页滚动查看。
  3. 单面板与多面板模式下，终端可读性保持可用，不出现严重裁切。
  4. fitAddon 仍正确发送 resize，服务端无报错。

  ### D. 回归检查

  1. 会话切换、会话删除滑动、新建终端流程不受影响。
  2. 文件管理与系统监控卡片可正常展开查看。
  ## Risks & Mitigations
  1. 风险：从“fixed 底栏 + 内部滚动”切到“整页滚动”后，软键盘适配可能产生偏移异常。
      - 处理：保留 visualViewport 监听，但减少对 dock 高度的耦合；真机验证键盘开合。
  2. 风险：终端最小高度下调后，初次 fit 行数不足。
      - 处理：必要时在 term.init() 后追加一次强制 resize 兜底。
  3. 风险：桌面端（@media min-width:900px）布局受影响。
      - 处理：为桌面端保留现有宽度居中样式，仅调整滚动容器策略。

  ## Assumptions / Defaults

  1. 已确认仅删除“自定义快捷键”，固定快捷键继续保留。
  2. 已确认控制面板展开后采用“整页一起滚动”模型。
  3. 已确认终端采用“小起始高度 + 按内容扩展”，不是完全无最小高度。
  4. 默认不改后端协议、不改 WebSocket 消息结构、不新增配置项。
