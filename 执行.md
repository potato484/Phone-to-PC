# C2P 执行说明（Ubuntu 22.04）

## 1. 前置条件

- 操作系统：Ubuntu 22.04
- Node.js：建议 `20+`
- 包管理器：推荐 `pnpm`（当前已安装）；`npm` 可用但可能遇到 peer 依赖冲突
- Shell：`bash`
- 编译依赖（仅当 `node-pty` 需要本地编译时）：`python3`、`make`、`g++`、`build-essential`

VNC 前置条件（本机已确认）：
- 已安装：`tightvncserver`、`tightvncpasswd`、`tigervnc-viewer`
- 未安装：TigerVNC 服务端（`x0vncserver` / `Xtigervnc`）
- 结论：当前按 TightVNC 路线运行桌面流（`127.0.0.1:5901`）

## 2. 安装依赖

```bash
cd /home/potato/computer-to-phone
pnpm install
```

如果你坚持用 `npm` 且遇到 `ERESOLVE`，使用：

```bash
npm install --legacy-peer-deps
```

## 3. 环境变量

首次可从模板创建：

```bash
cp .env.example .env
```

桌面流关键变量建议为：

```dotenv
C2P_VNC_HOST=127.0.0.1
C2P_VNC_PORT=5901
C2P_VNC_AUTOSTART=false
```

说明：
- `C2P_VNC_AUTOSTART=false` 表示由你手动启动 VNC，更稳定可控。
- 生产或公网场景再按需配置 `TUNNEL`、VAPID 等变量。

## 4. 启动 TightVNC（必须先于桌面连接）

忘记 VNC 密码时先重置：

```bash
vncpasswd
```

修改密码后需要重启当前 `:1` 会话，避免仍使用旧认证状态：

```bash
vncserver -kill :1 || true
rm -f /tmp/.X1-lock /tmp/.X11-unix/X1
vncserver :1 -localhost -geometry 1600x900 -depth 24
```

启动 VNC（`:1` 对应 `5901`）：

```bash
vncserver :1 -localhost -geometry 1600x900 -depth 24
```

验证 VNC 是否真的起来：

```bash
ss -lntp | rg ':5901\\b'
nc -vz 127.0.0.1 5901
```

若启动后秒退，可用最小 `xstartup`：

```bash
cat > ~/.vnc/xstartup <<'EOF'
#!/bin/sh
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
[ -r "$HOME/.Xresources" ] && xrdb "$HOME/.Xresources"
xsetroot -solid "#1f2233"
while true; do
  sleep 3600
done
EOF
chmod +x ~/.vnc/xstartup
```

## 5. 启动项目

开发模式：

```bash
npm run dev
```

生产模式：

```bash
npm run build
npm start
```

启动后日志会打印：

```text
[c2p] local: http://localhost:3000/#token=...
```

必须使用带 `#token=...` 的完整 URL 打开。

## 6. 凭据弹窗怎么填

- 按弹窗提示填写：可能是 `password`，也可能包含 `username` / `target`。
- 当前 TightVNC 常见情况是只要求 `password`。

## 7. 一步启动（推荐直接复制）

```bash
cd /home/potato/computer-to-phone
ss -lnt | rg -q ':5901\\b' || vncserver :1 -localhost -geometry 1600x900 -depth 24
npm run dev
```

## 8. 验收检查（是否通过）

```bash
TOKEN=$(cat .auth-token)
curl "http://127.0.0.1:3000/api/system/stats?token=$TOKEN"
```

验收标准：
- 返回 JSON 中 `vnc.available` 为 `true`
- 页面切到 Desktop 后不再报 `failed to start vnc`
- 键盘无响应时先点一下桌面画面区域获取焦点，再输入

## 9. 常见问题

- `401 unauthorized`：URL 中 token 不对，重新使用启动日志里完整链接。
- 桌面无响应：先确认 `5901` 在监听，再确认 `api/system/stats` 的 `vnc.available=true`。
- 你本机的 TigerVNC 仅是 viewer，不是 server，所以不需要配置 TigerVNC 服务端参数。
- 若手机端“输入密码后无反应”：先打开 `http://<你的IP>:3000/reset-cache.html#token=<你的token>`，等待自动跳转后再重试（用于清理旧 Service Worker 缓存）。
